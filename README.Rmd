---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
# options(tibble.print_min = 5, tibble.print_max = 5)
```


# `collinear` \n Automated Multicollinearity Management <a href="https://github.com/BlasBenito/collinear"><img src="man/figures/logo.png" align="right" height="138" /></a>



<!-- Development badges 

[![R-CMD-check](https://github.com/BlasBenito/collinear/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/BlasBenito/collinear/actions/workflows/R-CMD-check.yaml)
[![Devel-version](https://img.shields.io/badge/devel%20version-1.0.1-blue.svg)](https://github.com/blasbenito/collinear)

<!-- badges: start -->

[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.10039489.svg)](https://doi.org/10.5281/zenodo.10039489)
[![CRAN status](https://www.r-pkg.org/badges/version/collinear)](https://cran.r-project.org/package=collinear)
[![CRAN\_Download\_Badge](http://cranlogs.r-pkg.org/badges/grand-total/collinear)](https://CRAN.R-project.org/package=collinear)
[![R-CMD-check](https://github.com/BlasBenito/collinear/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/BlasBenito/collinear/actions/workflows/R-CMD-check.yaml)

<!-- badges: end -->


## Summary

The R package `collinear` provides a comprehensive toolkit for smart multicollinearity management in datasets with mixed variable types. The main function, [collinear()], is designed around five core components that work together to handle multicollinearity across numeric and categorical predictors:

 - **Target Encoding** (function [target_encoding_lab()]): Transparently converts categorical predictors to numeric when required, enabling VIF and correlation analysis across mixed data types.
 
 - **Intelligent Predictor Ranking** (function [preference_order()]): Prioritizes predictors by their association with the response, or allows a user-defined ranking to ensure that the most relevant ones are retained during filtering.
 
 - **Unified Correlation Framework** (function [cor_df()]): Computes pairwise correlations between any variable types using Pearson correlation (numeric-numeric), target encoding (numeric-categorical), and Cramer's V (categorical-categorical) within a single, consistent workflow.
 
 - **Adaptive Filtering Thresholds** (function [collinear()]): Automatically configures correlation and VIF thresholds based on each dataset's correlation structure, eliminating guesswork while allowing manual override.
 
 - **Dual Filtering Strategy** (function [collinear_select()]): Combines pairwise correlation and Variance Inflation Factor filtering while considering predictor rankings to manage multicollinearity while maximizing the predictive power of the resulting selection of predictors.

These methods are fully integrated into the function [collinear()] and its `tidymodels` wrapper, [step_collinear()]. This function handles the complete multicollinearity filtering workflow, from data validation to variable selection, returning filtered datasets and modeling formulas. 

The package also provides diagnostic functions ([cor_df()], [vif_df()], [collinear_stats()]) to help users assess multicollinearity in their data before and after filtering.

## Install

The package `collinear` can be installed from CRAN.

```{r, eval = FALSE}
install.packages("collinear")
```


The development version can be installed from GitHub.

```{r, eval = FALSE}
remotes::install_github(
  repo = "blasbenito/collinear", 
  ref = "development"
  )
```


Previous versions are in the “archive_xxx” branches of the GitHub repository.

```{r, eval = FALSE}
remotes::install_github(
  repo = "blasbenito/collinear", 
  ref = "archive_v2.0.0"
  )
```


## Getting Started

### Setup

Most functions in the `collinear` package support parallelization and progress bars via [`future`](https://future.futureverse.org/) and [`progressr`](https://progressr.futureverse.org/). Parallelization, however, is only advantageous for large datasets including categorical predictors.


```{r}
library(collinear)
library(future)
library(progressr)

future::plan(
  future::multisession,
  workers = future::availableCores() - 1
  )

#does not work in Rmarkdown
#progressr::handlers(global = TRUE)
```

### Example Data

The example dataframe [vi_smol] has several response variables and a large set of predictors. Here we focus on the numeric response `vi_numeric`, and the complete set of numeric and categorical predictors, stored in the vector [vi_predictors].

```{r}
data(vi_smol, vi_predictors)
nrow(vi_smol)
length(vi_predictors)
```

### Multicollinearity Analysis

The package provides several functions to assess multicollinearity. 

The functions [cor_df()] and [vif_df()] generate dataframes with the pairwise correlations and VIF scores of the predictors, while the functions [cor_stats()],  [vif_stats()] (used below) and [collinear_stats()] generate descriptive multicollinearity statistics.

```{r}
collinear::vif_stats(
  df = vi_smol,
  predictors = vi_predictors,
  quiet = TRUE
)
```
The quantile 0.75 returned by `vif_stats()` indicates that 25% of the predictors have a VIF score higher than 6. This is a robust indicator of high multicollinearity in our predictors.

### Multicollinearity Filtering

The function [collinear()] is designed to reduce multicollinearity in complex modelling data with a minimal setup.

```{r}
x <- collinear::collinear(
  df = vi_smol,
  response = "vi_numeric",
  predictors = vi_predictors
)
```

The function returns an object of class `collinear_output`, that has its own `print()` and `summary()` methods.

```{r}
x
```

The object `df` contains the response and the selected predictors.

```{r}
colnames(x$vi_numeric$df)
```
The object `preference_order` contains the ranking of predictors. It is computed by the function [preference_order] by assessing the association between the response and the predictors. In this case, it fits univariate models between the response and each predictor using [f_numeric_rf], and returns the R-squared of the observations vs the model predictions. This ranking ensures that the most important predictors are protected during multicollinearity filtering.

```{r}
head(x$vi_numeric$preference_order)
```

The object `selection` contains non-collinear predictors chosen by taking into account their pairwise correlation and VIF against all other predictors, and their position in the ranking above.

```{r}
x$vi_numeric$selection
```
We can check that this selection of predictors shows low multicollinearity by running the function [vif_df()] on them.

```{r}
collinear::vif_df(
  df = x$vi_numeric$df,
  predictors = x$vi_numeric$selection
)
```
All VIF scores are below 2.5, `collinear()` did a good job here!

Finally, `collinear()` also returns modeling formulas to help kick start exploratory modelling.

```{r}
x$vi_numeric$formulas
```
The function returns linear formulas for numeric outcomes, and classification formulas for categorical outcomes.

### Model Fitting

The output of `collinear()` can be used right away to fit exploratory models, as shown below.

```{r}
m <- stats::lm(
  formula = x$vi_numeric$formulas$linear, 
  data = x$vi_numeric$df,
  na.action = na.omit
  )

summary(m)
```
## Integration with `tidymodels`

The function [step_collinear()] wraps [collinear()] to facilitate its usage in `tidymodels` recipes.

```{r}
library(dplyr)
library(recipes)
library(parsnip)
library(workflows)

# model formula
vi_formula <- collinear::model_formula(
  df = vi_smol,
  response = "vi_numeric",
  predictors = vi_predictors
)

# recipe
vi_recipe <- recipes::recipe(
  formula = vi_formula,
  data = vi_smol
  ) |>
  #multicollinearity filtering
  collinear::step_collinear(
    recipes::all_predictors()
  )

#linear model
vi_model <- parsnip::linear_reg() |>
  parsnip::set_engine("lm")

#create and fit workflow
vi_workflow <- workflows::workflow() |>
  workflows::add_recipe(vi_recipe) |>
  workflows::add_model(vi_model) |>
  workflows::fit(data = vi_smol)

vi_workflow
```



## Citation

If you find this package useful, please cite it as:

*Blas M. Benito (2025). collinear: R Package for Seamless Multicollinearity Management. Version 3.0.0. doi: 10.5281/zenodo.10039489*

## Getting help

If you encounter bugs or issues with the documentation, please [file a issue on GitHub](https://github.com/BlasBenito/collinear/issues).
